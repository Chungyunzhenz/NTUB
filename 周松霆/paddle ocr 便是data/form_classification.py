import cv2
import numpy as np
from tensorflow.keras.models import load_model
import sys

# 提取並處理圖像
def extract_and_process_image(image_path, boxes):
    image = cv2.imread(image_path)  # 讀取圖像
    processed_images = []
    for (x1, y1, x2, y2) in boxes:
        white_bg = np.ones(image.shape, dtype=np.uint8) * 255  # 創建白色背景
        cv2.rectangle(white_bg, (x1, y1), (x2, y2), (0, 0, 0), thickness=cv2.FILLED)  # 在白色背景上畫矩形
        resized_bg = cv2.resize(white_bg, (64, 64))  # 調整大小為 (64, 64)
        gray_bg = cv2.cvtColor(resized_bg, cv2.COLOR_BGR2GRAY)  # 轉換為灰度圖像
        processed_images.append(gray_bg)
    processed_images = np.array(processed_images)
    processed_images = processed_images[..., np.newaxis]  # 添加新維度，使其變為 (64, 64, 1)
    return processed_images

# 分類表單圖像
def classify_form(image_path, boxes, model_path):
    model = load_model(model_path)  # 載入訓練好的模型
    processed_images = extract_and_process_image(image_path, boxes)  # 提取並處理圖像
    predictions = model.predict(processed_images)  # 進行預測
    prediction_classes = np.argmax(predictions, axis=1)  # 獲取預測結果的類別
    return prediction_classes

if __name__ == "__main__":
    if len(sys.argv) != 4:
        print("Usage: python form_classification.py <image_path> <leave_boxes|course_boxes> <model_path>")
        sys.exit(1)

    image_path = sys.argv[1]
    box_type = sys.argv[2]
    model_path = sys.argv[3]

    # 請假單的標示框座標
    leave_boxes = [
        (298, 28, 920, 64),
        (793, 69, 866, 92),
        (897, 66, 1134, 96),
        (288, 97, 364, 127),
        (78, 109, 136, 140),
        (387, 109, 444, 142),
        (675, 105, 730, 141),
        (905, 104, 963, 142),
        (271, 129, 296, 152),
        (334, 129, 363, 152),
        (785, 157, 941, 185),
        (91, 168, 191, 198),
        (654, 168, 755, 198),
        (951, 160, 1141, 183),
        (780, 188, 1094, 216),
        (226, 221, 246, 244),
        (281, 218, 313, 246),
        (344, 219, 368, 244),
        (402, 218, 491, 248),
        (522, 218, 552, 246),
        (582, 219, 607, 244),
        (780, 219, 1048, 248),
        (91, 231, 193, 259),
        (640, 236, 695, 261),
        (223, 248, 251, 277),
        (281, 249, 311, 277),
        (343, 251, 366, 276),
        (402, 248, 492, 277),
        (524, 249, 549, 274),
        (580, 248, 609, 277),
        (777, 251, 1083, 279),
        (163, 287, 263, 317),
        (545, 283, 660, 317),
        (981, 287, 1069, 315),
        (78, 312, 108, 342),
        (150, 327, 276, 355),
        (640, 323, 765, 353),
        (79, 337, 107, 376),
        (346, 340, 471, 368),
        (988, 338, 1066, 370),
        (151, 356, 276, 386),
        (529, 356, 679, 384),
        (775, 358, 827, 384),
        (76, 371, 110, 403),
        (78, 401, 108, 434),
        (207, 433, 225, 463),
        (270, 441, 307, 453),
        (401, 436, 422, 459),
        (467, 439, 501, 455),
        (594, 436, 617, 460),
        (667, 437, 692, 460),
        (793, 436, 815, 459),
        (1048, 436, 1071, 460),
        (1121, 437, 1144, 460),
        (477, 474, 772, 502),
        (817, 510, 891, 541),
        (920, 506, 1137, 547),
        (289, 543, 368, 573),
        (78, 553, 136, 586),
        (388, 552, 440, 590),
        (677, 554, 735, 586),
        (908, 553, 965, 586),
        (273, 574, 299, 597),
        (334, 574, 363, 597),
        (652, 606, 813, 629),
        (803, 604, 1136, 632),
        (93, 634, 193, 663),
        (526, 634, 629, 662),
        (649, 634, 948, 662),
        (943, 637, 1134, 660),
        (644, 665, 956, 693),
        (229, 698, 245, 729),
        (344, 700, 374, 728),
        (466, 701, 489, 728),
        (584, 698, 674, 728),
        (763, 698, 793, 728),
        (846, 698, 876, 728),
        (93, 711, 195, 741),
        (941, 711, 994, 742),
        (1086, 711, 1114, 742),
        (226, 729, 249, 754),
        (344, 726, 374, 756),
        (466, 729, 489, 756),
        (584, 729, 674, 757),
        (763, 728, 793, 757),
        (846, 728, 876, 756),
        (91, 772, 194, 811),
        (482, 838, 777, 866),
        (815, 874, 891, 904),
        (919, 869, 1137, 909),
        (78, 916, 136, 947),
        (289, 908, 364, 932),
        (387, 916, 444, 947),
        (679, 913, 733, 949),
        (908, 916, 963, 949),
        (269, 934, 369, 964),
        (650, 965, 815, 993),
        (823, 964, 1023, 993),
        (1014, 969, 1134, 992),
        (91, 995, 191, 1025),
        (527, 995, 629, 1025),
        (649, 997, 945, 1020),
        (948, 995, 1136, 1025),
        (644, 1025, 956, 1056),
        (223, 1064, 243, 1087),
        (338, 1061, 368, 1089),
        (461, 1063, 486, 1087),
        (580, 1059, 670, 1087),
        (762, 1063, 787, 1087),
        (856, 1063, 881, 1087),
        (91, 1074, 193, 1104),
        (960, 1072, 1013, 1106),
        (1104, 1072, 1133, 1104),
        (223, 1092, 244, 1115),
        (339, 1089, 368, 1120),
        (461, 1091, 484, 1117),
        (580, 1091, 669, 1120),
        (760, 1089, 788, 1119),
        (858, 1091, 881, 1117),
        (116, 1120, 170, 1145),
        (622, 1120, 677, 1148),
        (336, 1130, 436, 1158),
        (886, 1130, 983, 1158),
        (91, 1145, 191, 1168),
        (624, 1142, 732, 1170),
        (116, 1172, 168, 1198),
        (624, 1172, 675, 1198),
        (338, 1183, 434, 1211),
        (886, 1183, 983, 1211),
        (80, 1196, 181, 1219),
        (624, 1196, 730, 1219),
        (85, 1231, 615, 1259),
        (86, 1264, 105, 1279),
        (131, 1261, 1141, 1284),
        (131, 1282, 220, 1310),
        (83, 1308, 106, 1330),
        (133, 1308, 940, 1332),
        (83, 1332, 105, 1355),
        (133, 1333, 1141, 1356),
        (133, 1356, 920, 1379),
        (82, 1386, 104, 1397),
        (135, 1381, 1139, 1404),
        (135, 1406, 557, 1427),
        (85, 1431, 101, 1449),
        (133, 1429, 961, 1452),
        (83, 1452, 105, 1475),
        (133, 1454, 679, 1477),
        (83, 1477, 106, 1497),
        (133, 1477, 1139, 1500),
        (135, 1502, 1073, 1525),
        (83, 1525, 106, 1546),
        (133, 1526, 1084, 1548)
    ]

    # 選課單的標示框座標
    course_boxes = [
        (326, 60, 862, 95),
        (699, 100, 816, 130),
        (880, 103, 903, 128),
        (967, 107, 985, 126),
        (1050, 109, 1066, 124),
        (205, 137, 308, 167),
        (693, 131, 892, 165),
        (900, 137, 1091, 161),
        (83, 154, 184, 184),
        (694, 158, 892, 189),
        (207, 172, 306, 202),
        (359, 170, 439, 202),
        (901, 163, 1091, 188),
        (699, 188, 889, 212),
        (901, 188, 1091, 212),
        (205, 214, 306, 244),
        (357, 208, 438, 246),
        (590, 205, 691, 235),
        (491, 216, 570, 242),
        (684, 210, 786, 241),
        (799, 214, 988, 238),
        (83, 231, 181, 263),
        (205, 249, 283, 280),
        (359, 243, 436, 281),
        (698, 240, 786, 265),
        (799, 240, 995, 265),
        (985, 240, 1091, 265),
        (696, 261, 749, 292),
        (740, 265, 784, 291),
        (87, 296, 113, 321),
        (154, 296, 177, 321),
        (480, 310, 560, 342),
        (815, 314, 843, 338),
        (846, 312, 889, 340),
        (986, 311, 1008, 341),
        (1066, 316, 1094, 338),
        (78, 333, 189, 358),
        (81, 373, 184, 403),
        (232, 377, 255, 401),
        (599, 375, 685, 401),
        (83, 428, 182, 458),
        (189, 430, 852, 454),
        (73, 480, 425, 505),
        (170, 510, 1071, 535),
        (123, 534, 272, 568),
        (321, 542, 448, 561),
        (476, 542, 597, 561),
        (602, 542, 687, 561),
        (680, 538, 816, 563),
        (848, 540, 875, 561),
        (916, 540, 1066, 563),
        (166, 736, 570, 761),
        (599, 736, 662, 763),
        (184, 761, 669, 792),
        (701, 761, 801, 787),
        (831, 752, 999, 782),
        (165, 791, 347, 820),
        (73, 831, 421, 856),
        (489, 831, 680, 856),
        (714, 825, 823, 861),
        (915, 825, 1021, 861),
        (257, 868, 446, 892),
        (489, 868, 678, 892),
        (714, 862, 933, 898),
        (257, 905, 565, 929),
        (747, 901, 852, 931),
        (912, 901, 995, 933),
        (253, 943, 377, 973),
        (245, 985, 460, 1017),
        (245, 1027, 460, 1059),
        (74, 1075, 236, 1099),
        (73, 1143, 634, 1173),
        (398, 1194, 499, 1224),
        (583, 1194, 646, 1227),
        (140, 1218, 243, 1248),
        (345, 1220, 551, 1245),
        (586, 1231, 1109, 1255),
        (359, 1243, 535, 1268),
        (590, 1264, 1109, 1289),
        (73, 1280, 135, 1306),
        (315, 1280, 379, 1306),
        (636, 1296, 892, 1320),
        (586, 1327, 1116, 1352),
        (634, 1357, 894, 1387),
        (74, 1376, 158, 1402),
        (319, 1378, 400, 1402),
        (584, 1392, 774, 1417),
        (586, 1424, 1109, 1448),
        (581, 1455, 985, 1480),
        (71, 1473, 581, 1501),
        (73, 1495, 1121, 1523),
        (69, 1518, 1121, 1559),
        (76, 1548, 296, 1573),
        (586, 1560, 808, 1585)
    ]

    # 根據輸入參數選擇相應的標示框
    if box_type == "leave_boxes":
        boxes = leave_boxes
    elif box_type == "course_boxes":
        boxes = course_boxes
    else:
        print("Invalid box type. Choose 'leave_boxes' or 'course_boxes'.")
        sys.exit(1)

    # 分類表單
    prediction_classes = classify_form(image_path, boxes, model_path)

    # 打印預測結果
    for i, pred in enumerate(prediction_classes):
        form_type = "Leave Form" if pred == 0 else "Course Form"
        print(f"Box {i}: {form_type}")
